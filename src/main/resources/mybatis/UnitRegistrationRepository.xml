<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cebucouncilbsp.backend.repository.UnitRegistrationRepository">

  <resultMap id="UnitRegistrationResultMap" type="UnitRegistrationEntity">
    <id column="FORM_ID" jdbcType="INTEGER" property="formId"/>
    <result column="INSTITUTION_ID" jdbcType="INTEGER" property="institutionId"/>
    <result column="INSTITUTION_NAME" jdbcType="VARCHAR" property="institutionName"/>
    <result column="DISTRICT" jdbcType="VARCHAR" property="district"/>
    <result column="UNIT_NUMBER" jdbcType="VARCHAR" property="unitNumber"/>
    <result column="UNIT_REGISTRATION_NO" jdbcType="VARCHAR" property="unitRegistrationNo"/>
    <result column="CHARTER_FLAG" jdbcType="BOOLEAN" property="charterFlag"/>
    <result column="SECTION_CODE" jdbcType="VARCHAR" property="sectionCode"/>
    <result column="STATUS_CODE" jdbcType="VARCHAR" property="statusCode"/>
    <result column="DATE_APPLIED" jdbcType="TIMESTAMP" property="dateApplied"/>
    <result column="OFFICIAL_RECEIPT_NO" jdbcType="VARCHAR" property="officialReceiptNo"/>
    <result column="OFFICIAL_RECEIPT_DATE" jdbcType="DATE" property="officialReceiptDate"/>
    <result column="EXPIRATION_DATE" jdbcType="DATE" property="expirationDate"/>
    <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
    <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
    <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
    <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
    <collection property="iscomMembersList" ofType="ISComDetailsEntity">
      <result column="ISCOM_ID" jdbcType="INTEGER" property="iSComId"/>
      <result column="FORM_ID" jdbcType="INTEGER" property="formId"/>
      <result column="POSITION_CODE" jdbcType="VARCHAR" property="positionCode"/>
      <result column="SURNAME" jdbcType="VARCHAR" property="surname"/>
      <result column="GIVEN_NAME" jdbcType="VARCHAR" property="givenName"/>
      <result column="MIDDLE_INITIAL" jdbcType="VARCHAR" property="middleInitial"/>
      <result column="SIGNATURE" jdbcType="VARCHAR" property="signature"/>
      <result column="AGE" jdbcType="INTEGER" property="age"/>
      <result column="MEMBERSHIP_CERT_NO" jdbcType="VARCHAR" property="membershipCertNo"/>
      <result column="HIGHEST_TRAINING_CODE" jdbcType="VARCHAR" property="highestTrainingCode"/>
      <result column="TENURE" jdbcType="INTEGER" property="tenure"/>
      <result column="RELIGION" jdbcType="VARCHAR" property="religion"/>
      <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
      <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
      <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
      <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
    </collection>
    <collection property="unitMembersList" ofType="MemberDetailsEntity">
      <result column="MEMBER_ID" jdbcType="INTEGER" property="memberId"/>
      <result column="FORM_ID" jdbcType="INTEGER" property="formId"/>
      <result column="POSITION_CODE" jdbcType="VARCHAR" property="positionCode"/>
      <result column="SURNAME" jdbcType="VARCHAR" property="surname"/>
      <result column="GIVEN_NAME" jdbcType="VARCHAR" property="givenName"/>
      <result column="MIDDLE_INITIAL" jdbcType="VARCHAR" property="middleInitial"/>
      <result column="REGISTRATION_STATUS_CODE" jdbcType="VARCHAR" property="registrationStatusCode"/>
      <result column="AGE" jdbcType="INTEGER" property="age"/>
      <result column="MEMBERSHIP_CERT_NO" jdbcType="VARCHAR" property="membershipCertNo"/>
      <result column="HIGHEST_BADGE_CODE" jdbcType="VARCHAR" property="highestBadgeCode"/>
      <result column="TENURE" jdbcType="INTEGER" property="tenure"/>
      <result column="RELIGION" jdbcType="VARCHAR" property="religion"/>
      <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
      <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
      <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
      <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
    </collection>
  </resultMap>

  <resultMap id="UnitRegistrationSearchResultMap" type="UnitRegistrationSearchResultEntity">
    <id column="FORM_ID" jdbcType="INTEGER" property="formId"/>
    <result column="UNIT_REGISTRATION_NO" jdbcType="VARCHAR" property="unitRegistrationNo"/>
    <result column="INSTITUTION_NAME" jdbcType="INTEGER" property="institutionName"/>
    <result column="DISTRICT" jdbcType="VARCHAR" property="district"/>
    <result column="STATUS_CODE" jdbcType="VARCHAR" property="statusCode"/>
    <result column="DATE_APPLIED" jdbcType="TIMESTAMP" property="dateApplied"/>
    <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
  </resultMap>

  <select id="findAllUnitRegistrations" parameterType="map" resultMap="UnitRegistrationResultMap" resultType="UnitRegistrationEntity">
    SELECT
      TUR.FORM_ID,
      TUR.INSTITUTION_ID,
      ( SELECT INSTITUTION_NAME FROM M_INSTITUTION WHERE INSTITUTION_ID = TUR.INSTITUTION_ID)
        AS INSTITUTION_NAME,
      ( SELECT DISTRICT FROM M_INSTITUTION WHERE INSTITUTION_ID = TUR.INSTITUTION_ID)
        AS DISTRICT,
      TUR.UNIT_NUMBER,
      TUR.UNIT_REGISTRATION_NO,
      TUR.CHARTER_FLAG,
      TUR.SECTION_CODE,
      TUR.STATUS_CODE,
      TUR.DATE_APPLIED,
      TUR.OFFICIAL_RECEIPT_NO,
      TUR.OFFICIAL_RECEIPT_DATE,
      TUR.EXPIRATION_DATE,
      TUR.CREATED_BY,
      TUR.CREATED_DATETIME,
      TUR.UPDATED_BY,
      TUR.UPDATED_DATETIME
    FROM
      T_UNIT_REGISTRATION TUR
  </select>

  <select id="findByFormId" parameterType="map" resultMap="UnitRegistrationResultMap" resultType="UnitRegistrationEntity">
    SELECT
      TUR.FORM_ID,
      TUR.INSTITUTION_ID,
      ( SELECT INSTITUTION_NAME FROM M_INSTITUTION WHERE INSTITUTION_ID = TUR.INSTITUTION_ID)
        AS INSTITUTION_NAME,
      ( SELECT DISTRICT FROM M_INSTITUTION WHERE INSTITUTION_ID = TUR.INSTITUTION_ID)
        AS DISTRICT,
      TUR.UNIT_NUMBER,
      TUR.UNIT_REGISTRATION_NO,
      TUR.CHARTER_FLAG,
      TUR.SECTION_CODE,
      TUR.STATUS_CODE,
      TUR.DATE_APPLIED,
      TUR.OFFICIAL_RECEIPT_NO,
      TUR.OFFICIAL_RECEIPT_DATE,
      TUR.EXPIRATION_DATE,
      TUR.CREATED_BY,
      TUR.CREATED_DATETIME,
      TUR.UPDATED_BY,
      TUR.UPDATED_DATETIME
    FROM
      T_UNIT_REGISTRATION TUR
    WHERE
      TUR.FORM_ID = #{formId,jdbcType=INTEGER}
  </select>

  <select id="findByAreaDistInstStatusName" parameterType="map" resultMap="UnitRegistrationSearchResultMap" resultType="UnitRegistrationSearchResultEntity">
    SELECT
      TUR.FORM_ID,
      TUR.UNIT_REGISTRATION_NO,
      MINST.INSTITUTION_NAME,
      MINST.DISTRICT,
      TUR.STATUS_CODE,
      TUR.DATE_APPLIED,
      TUR.UPDATED_DATETIME
    FROM
      T_UNIT_REGISTRATION TUR
    LEFT JOIN M_INSTITUTION MINST
    ON
      TUR.INSTITUTION_ID = MINST.INSTITUTION_ID
    WHERE
      MINST.AREA = #{area,jdbcType=VARCHAR}
      <if test="district != null">
        AND MINST.DISTRICT = #{district,jdbcType=VARCHAR}
      </if>
      <if test="institutionId != null">
        AND MINST.INSTITUTION_ID = #{institutionId,jdbcType=INTEGER}
      </if>
      <if test="name != null">
        AND TUR.FORM_ID IN (
          SELECT
            TUR.FORM_ID
          FROM
            T_UNIT_REGISTRATION TUR
          INNER JOIN T_MEMBER_DETAILS TMEMB
          ON
            TUR.FORM_ID = TMEMB.FORM_ID
          INNER JOIN T_ISCOM_DETAILS TISC
          ON
            TUR.FORM_ID = TISC.FORM_ID
          WHERE
            LOWER(TMEMB.SURNAME || ' ' || TMEMB.GIVEN_NAME) LIKE '%' || #{name,jdbcType=VARCHAR} || '%'
            OR LOWER(TISC.SURNAME || ' ' || TISC.GIVEN_NAME) LIKE '%' || #{name,jdbcType=VARCHAR} || '%'
          GROUP BY
		    TUR.FORM_ID
          )
      </if>
      <!-- AND TUR.STATUS_CODE = #{statusCode,jdbcType=VARCHAR}  -->
    ORDER BY
      TUR.DATE_APPLIED DESC,
      TUR.STATUS_CODE ASC
  </select>

  <select id="insertUnitRegistrationEntityForm" parameterType="map" resultType="Integer">
     INSERT INTO
       T_UNIT_REGISTRATION
     <trim prefix="(" suffix=")" suffixOverrides=",">
       INSTITUTION_ID,
       UNIT_NUMBER,
       UNIT_REGISTRATION_NO,
       CHARTER_FLAG,
       SECTION_CODE,
       STATUS_CODE,
       DATE_APPLIED,
       OFFICIAL_RECEIPT_NO,
       OFFICIAL_RECEIPT_DATE,
       EXPIRATION_DATE,
       CREATED_BY,
       CREATED_DATETIME,
       UPDATED_BY,
       UPDATED_DATETIME
     </trim>
     <trim prefix="values (" suffix=")" suffixOverrides=",">
       #{institutionId,jdbcType=INTEGER},
       #{unitNumber,jdbcType=VARCHAR},
       #{unitRegistrationNo,jdbcType=VARCHAR},
       #{charterFlag,jdbcType=BOOLEAN},
       #{sectionCode,jdbcType=VARCHAR},
       #{statusCode,jdbcType=VARCHAR},
       #{dateApplied,jdbcType=TIMESTAMP},
       #{officialReceiptNo,jdbcType=VARCHAR},
       #{officialReceiptDate,jdbcType=TIMESTAMP},
       #{expirationDate,jdbcType=TIMESTAMP},
       #{createdBy,jdbcType=VARCHAR},
       #{createdDateTime,jdbcType=TIMESTAMP},
       #{updatedBy,jdbcType=VARCHAR},
       #{updatedDateTime,jdbcType=TIMESTAMP}
     </trim>
     RETURNING FORM_ID
  </select>

  <update id="updateUnitRegistrationEntityForm" parameterType="UnitRegistrationEntity">
    UPDATE
      T_UNIT_REGISTRATION
    <set>
      INSTITUTION_ID = #{institutionId,jdbcType=INTEGER},
      UNIT_NUMBER = #{unitNumber,jdbcType=VARCHAR},
      UNIT_REGISTRATION_NO = #{unitRegistrationNo,jdbcType=VARCHAR},
      SECTION_CODE = #{sectionCode,jdbcType=VARCHAR},
      CHARTER_FLAG = #{charterFlag,jdbcType=BOOLEAN},
      STATUS_CODE = #{statusCode,jdbcType=VARCHAR},
      DATE_APPLIED = #{dateApplied,jdbcType=TIMESTAMP},
      OFFICIAL_RECEIPT_NO = #{officialReceiptNo,jdbcType=VARCHAR},
      OFFICIAL_RECEIPT_DATE = #{officialReceiptDate,jdbcType=TIMESTAMP},
      EXPIRATION_DATE = #{expirationDate,jdbcType=TIMESTAMP},
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      FORM_ID = #{formId,jdbcType=INTEGER}
  </update>

  <update id="updateFormStatus" parameterType="UnitRegistrationEntity">
    UPDATE
      T_UNIT_REGISTRATION
    <set>
      STATUS_CODE = #{statusCode,jdbcType=VARCHAR},
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      FORM_ID = #{formId,jdbcType=INTEGER}
  </update>

  <delete id="deleteUnitRegistrationFormByFormId" parameterType="map">
    DELETE FROM T_UNIT_REGISTRATION
    WHERE FORM_ID = #{formId,jdbcType=INTEGER}
  </delete>

</mapper>
