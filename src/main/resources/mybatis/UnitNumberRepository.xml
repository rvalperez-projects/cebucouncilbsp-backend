<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cebucouncilbsp.backend.repository.UnitNumberRepository">

  <resultMap id="UnitNumberEntityResultMap" type="UnitNumberEntity">
    <id column="UNIT_NUMBER" jdbcType="VARCHAR" property="unitNumber"/>
    <result column="INSTITUTION_ID" jdbcType="INTEGER" property="institutionId"/>
    <result column="SECTION_CODE" jdbcType="VARCHAR" property="sectionCode"/>
    <result column="LAST_USED_YEAR" jdbcType="INTEGER" property="lastUsedYear"/>
    <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
    <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
    <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
    <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
  </resultMap>

  <select id="findAllUnitNumbers" parameterType="map" resultMap="UnitNumberEntityResultMap" resultType="UnitNumberEntity">
    SELECT
      UNIT_NUMBER,
      INSTITUTION_ID,
      SECTION_CODE,
      LAST_USED_YEAR,
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    FROM
      M_UNIT_NUMBER
  </select>

  <select id="findAvailableUnitNumbers" parameterType="map" resultMap="UnitNumberEntityResultMap" resultType="UnitNumberEntity">
    SELECT
      UNIT_NUMBER,
      INSTITUTION_ID,
      SECTION_CODE,
      LAST_USED_YEAR,
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    FROM
      M_UNIT_NUMBER
    WHERE
      (LAST_USED_YEAR IS NULL
      OR (#{currentYear,jdbcType=INTEGER} - LAST_USED_YEAR) > 2)
      <if test='sectionCode != null'>
      	AND SECTION_CODE = #{sectionCode,jdbcType=VARCHAR}
      </if>
    ORDER BY
      SECTION_CODE ASC,
      LAST_USED_YEAR ASC
  </select>

  <select id="findByUnitNumber" parameterType="map" resultMap="UnitNumberEntityResultMap" resultType="UnitNumberEntity">
    SELECT
      UNIT_NUMBER,
      INSTITUTION_ID,
      SECTION_CODE,
      LAST_USED_YEAR,
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    FROM
      M_UNIT_NUMBER
    WHERE
      UNIT_NUMBER = #{unitNumber,jdbcType=VARCHAR}
  </select>

  <select id="findByInstitutionId" parameterType="map" resultMap="UnitNumberEntityResultMap" resultType="UnitNumberEntity">
    SELECT
      UNIT_NUMBER,
      INSTITUTION_ID,
      SECTION_CODE,
      LAST_USED_YEAR
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    FROM
      M_UNIT_NUMBER
    WHERE
      INSTITUTION_ID = #{institutionId,jdbcType=INTEGER}
      AND (LAST_USED_YEAR IS NULL
        OR #{currentYear,jdbcType=INTEGER} > LAST_USED_YEAR)
    ORDER BY
      SECTION_CODE ASC,
      LAST_USED_YEAR DESC
  </select>

  <insert id="insertUnitNumber" parameterType="UnitNumberEntity">
    INSERT INTO
      M_UNIT_NUMBER
    <trim prefix="(" suffix=")" suffixOverrides=",">
      UNIT_NUMBER,
      INSTITUTION_ID,
      SECTION_CODE,
      LAST_USED_YEAR,
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{unitNumber,jdbcType=VARCHAR},
      #{institutionId,jdbcType=INTEGER},
      #{sectionCode,jdbcType=VARCHAR},
      #{lastUsedYear,jdbcType=VARCHAR},
      #{validFlag,jdbcType=BOOLEAN},
      #{createdBy,jdbcType=VARCHAR},
      #{updatedBy,jdbcType=VARCHAR},
      #{createdDateTime,jdbcType=TIMESTAMP},
      #{updatedDateTime,jdbcType=TIMESTAMP}
    </trim>
  </insert>

  <update id="updateUnitNumber" parameterType="UnitNumberEntity">
    UPDATE
      M_UNIT_NUMBER
    <set>
      INSTITUTION_ID = #{institutionId,jdbcType=INTEGER},
      SECTION_CODE = #{sectionCode,jdbcType=VARCHAR},
      LAST_USED_YEAR = #{lastUsedYear,jdbcType=VARCHAR},
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      UNIT_NUMBER = #{unitNumber,jdbcType=VARCHAR}
  </update>

</mapper>
