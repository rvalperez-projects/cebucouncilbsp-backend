<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cebucouncilbsp.backend.repository.UserRepository">

  <resultMap id="UserResultMap" type="UserEntity">
    <id column="USER_ID" jdbcType="INTEGER" property="userId"/>
    <result column="SURNAME" jdbcType="VARCHAR" property="surname"/>
    <result column="GIVEN_NAME" jdbcType="VARCHAR" property="givenName"/>
    <result column="MIDDLE_INITIAL" jdbcType="VARCHAR" property="middleInitial"/>
    <result column="EMAIL_ADDRESS" jdbcType="VARCHAR" property="emailAddress"/>
    <result column="MOBILE_NUMBER" jdbcType="VARCHAR" property="mobileNumber"/>
    <result column="INSTITUTION_ID" jdbcType="INTEGER" property="institutionId"/>
    <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
    <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
    <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
    <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
  </resultMap>

  <resultMap id="UserSearchResultMap" type="UserSearchResultEntity">
    <id column="USER_ID" jdbcType="INTEGER" property="userId"/>
    <result column="SURNAME" jdbcType="VARCHAR" property="surname"/>
    <result column="GIVEN_NAME" jdbcType="VARCHAR" property="givenName"/>
    <result column="MIDDLE_INITIAL" jdbcType="VARCHAR" property="middleInitial"/>
    <result column="EMAIL_ADDRESS" jdbcType="VARCHAR" property="emailAddress"/>
    <result column="MOBILE_NUMBER" jdbcType="VARCHAR" property="mobileNumber"/>
    <result column="INSTITUTION_ID" jdbcType="INTEGER" property="institutionId"/>
    <result column="INSTITUTION_NAME" jdbcType="VARCHAR" property="institutionName"/>
    <result column="DISTRICT" jdbcType="VARCHAR" property="district"/>
  </resultMap>

  <select id="findAllUsers" parameterType="map" resultType="UserEntity" resultMap="UserResultMap">
    SELECT
      MUSR.USER_ID,
      MUSR.SURNAME,
      MUSR.GIVEN_NAME,
      MUSR.MIDDLE_INITIAL,
      MUSR.EMAIL_ADDRESS,
      MUSR.MOBILE_NUMBER,
      MUSR.INSTITUTION_ID,
      MUSR.CREATED_BY,
      MUSR.CREATED_DATETIME,
      MUSR.UPDATED_BY,
      MUSR.UPDATED_DATETIME
    FROM
      M_USER MUSR
  </select>

  <select id="findByUserId" parameterType="map" resultType="UserEntity" resultMap="UserResultMap">
    SELECT
      MUSR.USER_ID,
      MUSR.SURNAME,
      MUSR.GIVEN_NAME,
      MUSR.MIDDLE_INITIAL,
      MUSR.EMAIL_ADDRESS,
      MUSR.MOBILE_NUMBER,
      MUSR.INSTITUTION_ID,
      MUSR.CREATED_BY,
      MUSR.CREATED_DATETIME,
      MUSR.UPDATED_BY,
      MUSR.UPDATED_DATETIME
    FROM
      M_USER MUSR
    WHERE
      MUSR.USER_ID = #{userId,jdbcType=INTEGER}
  </select>

  <select id="findByAreaDistrictInstitutionName" parameterType="map" resultType="UserSearchResultEntity" resultMap="UserSearchResultMap">
    SELECT
      MUSR.USER_ID,
      MUSR.SURNAME,
      MUSR.GIVEN_NAME,
      MUSR.MIDDLE_INITIAL,
      MINST.INSTITUTION_NAME,
      MINST.DISTRICT,
      MUSR.EMAIL_ADDRESS,
      MUSR.MOBILE_NUMBER,
      MUSR.INSTITUTION_ID,
      MUSR.CREATED_BY,
      MUSR.CREATED_DATETIME,
      MUSR.UPDATED_BY,
      MUSR.UPDATED_DATETIME
    FROM
      M_USER MUSR
    LEFT JOIN M_INSTITUTION MINST
    ON
      MUSR.INSTITUTION_ID = MINST.INSTITUTION_ID
    WHERE
      MINST.AREA = #{area,jdbcType=VARCHAR}
      <if test="district != null">
        AND MINST.DISTRICT = #{district,jdbcType=VARCHAR}
      </if>
      <if test="institutionId != null">
        AND MINST.INSTITUTION_ID = #{institutionId,jdbcType=INTEGER}
      </if>
      <if test="name != null">
      	AND (LOWER(MUSR.SURNAME || ' ' || MUSR.GIVEN_NAME) LIKE '%' || #{name,jdbcType=VARCHAR} || '%')
      </if>
    ORDER BY
      MINST.DISTRICT ASC,
      MINST.INSTITUTION_NAME ASC,
      MUSR.SURNAME ASC
  </select>

  <select id="insertUser" parameterType="UserEntity" resultType="Integer">
    INSERT INTO
      M_USER
    <trim prefix="(" suffix=")" suffixOverrides=",">
      SURNAME,
      GIVEN_NAME,
      MIDDLE_INITIAL,
      EMAIL_ADDRESS,
      MOBILE_NUMBER,
      INSTITUTION_ID,
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{surname,jdbcType=VARCHAR},
      #{givenName,jdbcType=VARCHAR},
      #{middleInitial,jdbcType=VARCHAR},
      #{emailAddress,jdbcType=VARCHAR},
      #{mobileNumber,jdbcType=VARCHAR},
      #{institutionId,jdbcType=INTEGER},
      #{createdBy,jdbcType=VARCHAR},
      #{createdDateTime,jdbcType=TIMESTAMP},
      #{updatedBy,jdbcType=VARCHAR},
      #{updatedDateTime,jdbcType=TIMESTAMP}
    </trim>
    RETURNING USER_ID
  </select>

  <update id="updateUser" parameterType="UserEntity">
    UPDATE
      M_USER
    <set>
      SURNAME = #{surname,jdbcType=VARCHAR},
      GIVEN_NAME = #{givenName,jdbcType=VARCHAR},
      MIDDLE_INITIAL = #{middleInitial,jdbcType=VARCHAR},
      EMAIL_ADDRESS = #{emailAddress,jdbcType=VARCHAR},
      MOBILE_NUMBER = #{mobileNumber,jdbcType=VARCHAR},
      INSTITUTION_ID = #{institutionId,jdbcType=INTEGER},
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      USER_ID = #{userId,jdbcType=INTEGER}
  </update>

</mapper>
