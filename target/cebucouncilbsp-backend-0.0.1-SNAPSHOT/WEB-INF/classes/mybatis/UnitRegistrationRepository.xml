<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cebucouncilbsp.backend.repository.UnitRegistrationRepository">

  <resultMap id="UnitRegistrationResultMap" type="UnitRegistrationEntity">
    <id column="FORM_ID" jdbcType="INTEGER" property="formId"/>
    <result column="INSTITUTION_ID" jdbcType="INTEGER" property="institutionId"/>
    <result column="UNIT_NUMBER" jdbcType="VARCHAR" property="unitNumber"/>
    <result column="UNIT_REGISTRATION_NO" jdbcType="VARCHAR" property="unitRegistrationNo"/>
    <result column="SECTION_CODE" jdbcType="VARCHAR" property="sectionCode"/>
    <result column="STATUS_CODE" jdbcType="VARCHAR" property="statusCode"/>
    <result column="DATE_APPLIED" jdbcType="TIMESTAMP" property="dateApplied"/>
    <result column="OFFICIAL_RECEIPT_NO" jdbcType="VARCHAR" property="officialReceiptNo"/>
    <result column="OFFICIAL_RECEIPT_DATE" jdbcType="DATE" property="officialReceiptDate"/>
    <result column="EXPIRATION_DATE" jdbcType="DATE" property="expirationDate"/>
    <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
    <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
    <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
    <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
    <collection property="institutionalCommitteeList" ofType="ISComDetailsEntity">
      <result column="ISCOM_ID" jdbcType="INTEGER" property="iSComId"/>
      <result column="FORM_ID" jdbcType="INTEGER" property="formId"/>
      <result column="POSITION_CODE" jdbcType="VARCHAR" property="positionCode"/>
      <result column="SURNAME" jdbcType="VARCHAR" property="surname"/>
      <result column="GIVEN_NAME" jdbcType="VARCHAR" property="givenName"/>
      <result column="MIDDLE_INITIAL" jdbcType="VARCHAR" property="middleInitial"/>
      <result column="SIGNATURE" jdbcType="VARCHAR" property="signature"/>
      <result column="AGE" jdbcType="INTEGER" property="age"/>
      <result column="MEMBERSHIP_CERT_NO" jdbcType="VARCHAR" property="membershipCertNo"/>
      <result column="HIGHEST_TRAINING_CODE" jdbcType="VARCHAR" property="highestTrainingCode"/>
      <result column="TENURE" jdbcType="INTEGER" property="tenure"/>
      <result column="RELIGION" jdbcType="VARCHAR" property="religion"/>
      <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
      <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
      <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
      <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
    </collection>
    <collection property="patrolMembersList" ofType="MemberDetailsEntity">
      <result column="MEMBER_ID" jdbcType="INTEGER" property="memberId"/>
      <result column="FORM_ID" jdbcType="INTEGER" property="formId"/>
      <result column="POSITION_CODE" jdbcType="VARCHAR" property="positionCode"/>
      <result column="SURNAME" jdbcType="VARCHAR" property="surname"/>
      <result column="GIVEN_NAME" jdbcType="VARCHAR" property="givenName"/>
      <result column="MIDDLE_INITIAL" jdbcType="VARCHAR" property="middleInitial"/>
      <result column="REGISTRATION_STATUS_CODE" jdbcType="VARCHAR" property="registrationStatusCode"/>
      <result column="AGE" jdbcType="INTEGER" property="age"/>
      <result column="MEMBERSHIP_CERT_NO" jdbcType="VARCHAR" property="membershipCertNo"/>
      <result column="HIGHEST_BADGE_CODE" jdbcType="VARCHAR" property="highestBadgeCode"/>
      <result column="TENURE" jdbcType="INTEGER" property="tenure"/>
      <result column="RELIGION" jdbcType="VARCHAR" property="religion"/>
      <result column="CREATED_BY" jdbcType="VARCHAR" property="createdBy"/>
      <result column="CREATED_DATETIME" jdbcType="TIMESTAMP" property="createdDateTime"/>
      <result column="UPDATED_BY" jdbcType="VARCHAR" property="updatedBy"/>
      <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
    </collection>
  </resultMap>

  <resultMap id="UnitRegistrationSearchResultMap" type="UnitRegistrationSearchResultEntity">
    <id column="FORM_ID" jdbcType="INTEGER" property="formId"/>
    <result column="UNIT_REGISTRATION_NO" jdbcType="VARCHAR" property="unitRegistrationNo"/>
    <result column="INSTITUTION_NAME" jdbcType="INTEGER" property="institutionName"/>
    <result column="DISTRICT" jdbcType="VARCHAR" property="district"/>
    <result column="STATUS_CODE" jdbcType="VARCHAR" property="statusCode"/>
    <result column="DATE_APPLIED" jdbcType="TIMESTAMP" property="dateApplied"/>
    <result column="UPDATED_DATETIME" jdbcType="TIMESTAMP" property="updatedDateTime"/>
  </resultMap>

  <select id="findAllUnitRegistrations" parameterType="map" resultMap="UnitRegistrationResultMap" resultType="UnitRegistrationEntity">
    SELECT
      TUR.FORM_ID,
      TUR.INSTITUTION_ID,
      TUR.UNIT_NUMBER,
      TUR.UNIT_REGISTRATION_NO,
      TUR.SECTION_CODE,
      TUR.STATUS_CODE,
      TUR.DATE_APPLIED,
      TUR.OFFICIAL_RECEIPT_NO,
      TUR.OFFICIAL_RECEIPT_DATE,
      TUR.EXPIRATION_DATE,
      TUR.CREATED_BY,
      TUR.CREATED_DATETIME,
      TUR.UPDATED_BY,
      TUR.UPDATED_DATETIME
    FROM
      T_UNIT_REGISTRATION TUR
  </select>

  <select id="findByFormId" parameterType="map" resultMap="UnitRegistrationResultMap" resultType="UnitRegistrationEntity">
    SELECT
      TUR.FORM_ID,
      TUR.INSTITUTION_ID,
      TUR.UNIT_NUMBER,
      TUR.UNIT_REGISTRATION_NO,
      TUR.SECTION_CODE,
      TUR.STATUS_CODE,
      TUR.DATE_APPLIED,
      TUR.OFFICIAL_RECEIPT_NO,
      TUR.OFFICIAL_RECEIPT_DATE,
      TUR.EXPIRATION_DATE,
      TUR.CREATED_BY,
      TUR.CREATED_DATETIME,
      TUR.UPDATED_BY,
      TUR.UPDATED_DATETIME
    FROM
      T_UNIT_REGISTRATION TUR
    WHERE
      TUR.FORM_ID = #{formId,jdbcType=INTEGER}
  </select>

  <select id="findByAreaDistInstStatusName" parameterType="map" resultMap="UnitRegistrationSearchResultMap" resultType="UnitRegistrationSearchResultEntity">
    SELECT
      TUR.FORM_ID,
      TUR.UNIT_REGISTRATION_NO,
      MINST.INSTITUTION_NAME,
      MINST.DISTRICT,
      TUR.STATUS_CODE,
      TUR.DATE_APPLIED,
      TUR.UPDATED_DATETIME
    FROM
      T_UNIT_REGISTRATION TUR
    LEFT JOIN M_INSTITUTION MINST
    ON
      TUR.INSTITUTION_ID = MINST.INSTITUTION_ID
    WHERE
      <if test="area != null">
        MINST.AREA = #{area,jdbcType=VARCHAR} AND
      </if>
      <if test="district != null">
        MINST.DISTRICT = #{district,jdbcType=VARCHAR} AND
      </if>
      <if test="institutionId != null">
        MINST.INSTITUTION_ID = #{institutionId,jdbcType=INTEGER} AND
      </if>
      <if test="name != null">
        TUR.FORM_ID IN (
          SELECT
            TUR.FORM_ID
          FROM
            T_UNIT_REGISTRATION TUR
          INNER JOIN T_MEMBER_DETAILS TMEMB
          ON
            TUR.FORM_ID = TMEMB.FORM_ID
          INNER JOIN T_ISCOM_DETAILS TISC
          ON
            TUR.FORM_ID = TISC.FORM_ID
          WHERE
            LOWER(TMEMB.SURNAME || ' ' || TMEMB.GIVEN_NAME) LIKE '%' || #{name,jdbcType=VARCHAR} || '%'
            OR LOWER(TISC.SURNAME || ' ' || TISC.GIVEN_NAME) LIKE '%' || #{name,jdbcType=VARCHAR} || '%'
          GROUP BY
		    TUR.FORM_ID
          ) AND
      </if>
      TUR.STATUS_CODE = #{statusCode,jdbcType=VARCHAR}
    ORDER BY
      TUR.DATE_APPLIED DESC,
      TUR.STATUS_CODE ASC
  </select>

  <insert id="insertUnitRegistrationEntityForm" parameterType="map">
    WITH INSERTED_FORM AS (
      INSERT INTO
        T_UNIT_REGISTRATION
      <trim prefix="(" suffix=")" suffixOverrides=",">
        INSTITUTION_ID,
        UNIT_NUMBER,
        UNIT_REGISTRATION_NO,
        SECTION_CODE,
        STATUS_CODE,
        DATE_APPLIED,
        OFFICIAL_RECEIPT_NO,
        OFFICIAL_RECEIPT_DATE,
        EXPIRATION_DATE,
        CREATED_BY,
        CREATED_DATETIME,
        UPDATED_BY,
        UPDATED_DATETIME
      </trim>
      <trim prefix="values (" suffix=")" suffixOverrides=",">
        #{institutionId,jdbcType=INTEGER},
        #{unitNumber,jdbcType=VARCHAR},
        #{unitRegistrationNo,jdbcType=VARCHAR},
        #{sectionCode,jdbcType=VARCHAR},
        #{statusCode,jdbcType=VARCHAR},
        #{dateApplied,jdbcType=TIMESTAMP},
        #{officialReceiptNo,jdbcType=VARCHAR},
        #{officialReceiptDate,jdbcType=TIMESTAMP},
        #{expirationDate,jdbcType=TIMESTAMP},
        #{createdBy,jdbcType=VARCHAR},
        #{createdDateTime,jdbcType=TIMESTAMP},
        #{updatedBy,jdbcType=VARCHAR},
        #{updatedDateTime,jdbcType=TIMESTAMP}
      </trim>
      RETURNING FORM_ID
    ),
    INSERTED_ISCOM AS (
      INSERT INTO
        T_ISCOM_DETAILS
      <trim prefix="(" suffix=")" suffixOverrides=",">
        FORM_ID,
        POSITION_CODE,
        SURNAME,
        GIVEN_NAME,
        MIDDLE_INITIAL,
        SIGNATURE,
        AGE,
        MEMBERSHIP_CERT_NO,
        HIGHEST_TRAINING_CODE,
        TENURE,
        RELIGION,
        CREATED_BY,
        CREATED_DATETIME,
        UPDATED_BY,
        UPDATED_DATETIME
      </trim>
      <foreach item="committee" collection="institutionalCommitteeList" open="values" separator="," close="">
        <trim prefix="(" suffix=")" suffixOverrides=",">
          (SELECT FORM_ID FROM INSERTED_FORM),
          #{committee.positionCode,jdbcType=VARCHAR},
          #{committee.surname,jdbcType=VARCHAR},
          #{committee.givenName,jdbcType=VARCHAR},
          #{committee.middleInitial,jdbcType=VARCHAR},
          #{committee.signature,jdbcType=VARCHAR},
          #{committee.age,jdbcType=INTEGER},
          #{committee.membershipCertNo,jdbcType=VARCHAR},
          #{committee.highestTrainingCode,jdbcType=VARCHAR},
          #{committee.tenure,jdbcType=INTEGER},
          #{committee.religion,jdbcType=VARCHAR},
          #{committee.createdBy,jdbcType=VARCHAR},
          #{committee.createdDateTime,jdbcType=TIMESTAMP},
          #{committee.updatedBy,jdbcType=VARCHAR},
          #{committee.updatedDateTime,jdbcType=TIMESTAMP}
        </trim>
      </foreach>
    ),
    INSERTED_MEMBERS AS (
    INSERT INTO
      T_MEMBER_DETAILS
    <trim prefix="(" suffix=")" suffixOverrides=",">
      FORM_ID,
      POSITION_CODE,
      SURNAME,
      GIVEN_NAME,
      MIDDLE_INITIAL,
      REGISTRATION_STATUS_CODE,
      AGE,
      MEMBERSHIP_CERT_NO,
      HIGHEST_BADGE_CODE,
      TENURE,
      RELIGION,
      CREATED_BY,
      CREATED_DATETIME,
      UPDATED_BY,
      UPDATED_DATETIME
    </trim>
    <foreach item="member" collection="patrolMembersList" open="values" separator="," close="">
      <trim prefix="(" suffix=")" suffixOverrides=",">
        (SELECT FORM_ID FROM INSERTED_FORM),
        #{member.positionCode,jdbcType=VARCHAR},
        #{member.surname,jdbcType=VARCHAR},
        #{member.givenName,jdbcType=VARCHAR},
        #{member.middleInitial,jdbcType=VARCHAR},
        #{member.registrationStatusCode,jdbcType=VARCHAR},
        #{member.age,jdbcType=INTEGER},
        #{member.membershipCertNo,jdbcType=VARCHAR},
        #{member.highestBadgeCode,jdbcType=VARCHAR},
        #{member.tenure,jdbcType=INTEGER},
        #{member.religion,jdbcType=VARCHAR},
        #{member.createdBy,jdbcType=VARCHAR},
        #{member.createdDateTime,jdbcType=TIMESTAMP},
        #{member.updatedBy,jdbcType=VARCHAR},
        #{member.updatedDateTime,jdbcType=TIMESTAMP}
      </trim>
    </foreach>
    )
    UPDATE
      M_UNIT_NUMBER
    <set>
      INSTITUTION_ID = #{institutionId,jdbcType=INTEGER},
      SECTION_CODE = #{sectionCode,jdbcType=VARCHAR},
      LAST_USED_YEAR = extract (YEAR from NOW()),
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      UNIT_NUMBER = #{unitNumber,jdbcType=VARCHAR}
  </insert>

  <update id="updateUnitRegistrationEntityForm" parameterType="UnitRegistrationEntity">
    UPDATE
      T_UNIT_REGISTRATION
    <set>
      INSTITUTION_ID = #{institutionId,jdbcType=INTEGER},
      UNIT_NUMBER = #{unitNumber,jdbcType=VARCHAR},
      UNIT_REGISTRATION_NO = #{unitRegistrationNo,jdbcType=VARCHAR},
      SECTION_CODE = #{sectionCode,jdbcType=VARCHAR},
      STATUS_CODE = #{statusCode,jdbcType=VARCHAR},
      DATE_APPLIED = #{dateApplied,jdbcType=TIMESTAMP},
      OFFICIAL_RECEIPT_NO = #{officialReceiptNo,jdbcType=VARCHAR},
      OFFICIAL_RECEIPT_DATE = #{officialReceiptDate,jdbcType=TIMESTAMP},
      EXPIRATION_DATE = #{expirationDate,jdbcType=TIMESTAMP},
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      FORM_ID = #{formId,jdbcType=INTEGER}
  </update>

  <update id="updateFormStatus" parameterType="UnitRegistrationEntity">
    UPDATE
      T_UNIT_REGISTRATION
    <set>
      STATUS_CODE = #{statusCode,jdbcType=VARCHAR},
      UPDATED_BY = #{updatedBy,jdbcType=VARCHAR},
      UPDATED_DATETIME = #{updatedDateTime,jdbcType=TIMESTAMP}
    </set>
    WHERE
      FORM_ID = #{formId,jdbcType=INTEGER}
  </update>

</mapper>
